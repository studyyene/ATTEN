<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Attendance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --bg-light: #f9f9f9;
      --text-light: #1a1a1a;
      --card-bg-light: #ffffff;
      --bg-dark: #121212;
      --text-dark: #ffffff;
      --card-bg-dark: #1f1f1f;
    }

    [data-theme="light"] {
      --bg: var(--bg-light);
      --text: var(--text-light);
      --card-bg: var(--card-bg-light);
    }

    [data-theme="dark"] {
      --bg: var(--bg-dark);
      --text: var(--text-dark);
      --card-bg: var(--card-bg-dark);
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: #4caf50;
      color: white;
      transition: background 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin: 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      width: 260px;
      transition: background 0.3s;
    }

    .risk {
      color: #ff5252;
      font-weight: bold;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .ring {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 10px auto;
    }

    .ring svg {
      transform: rotate(-90deg);
    }

    .ring circle {
      fill: none;
      stroke-width: 10;
    }

    .ring .bg {
      stroke: #444;
    }

    .ring .progress {
      stroke: #4caf50;
      stroke-linecap: round;
    }

    .ring span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: bold;
    }

    canvas {
      background: var(--card-bg);
      border-radius: 12px;
      margin: 30px auto;
      padding: 10px;
      transition: background 0.3s;
      display: block;
      max-width: 800px;
    }

    .summary {
      text-align: center;
      font-size: 20px;
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìò My Attendance Dashboard</h1>
    <div class="controls">
      <button id="themeToggle">üåó Toggle Theme</button>
      <button onclick="exportPDF()">üì§ Export PDF</button>
    </div>
    <input id="regNoInput" placeholder="Enter Your Reg No" style="padding: 8px; font-size: 14px; margin-top: 10px;" />
    <button onclick="loadData()">üîç Load Attendance</button>
  </div>
  <div id="container" class="container"></div>
  <div class="summary" id="overall"></div>
  <canvas id="monthlyChart" width="800" height="300"></canvas>

  <script>
    const themeToggle = document.getElementById("themeToggle");
    const html = document.documentElement;
    let darkMode = true;

    themeToggle.addEventListener("click", () => {
      darkMode = !darkMode;
      html.setAttribute("data-theme", darkMode ? "dark" : "light");
      localStorage.setItem("theme", darkMode ? "dark" : "light");
    });

    if (localStorage.getItem("theme") === "light") {
      html.setAttribute("data-theme", "light");
      darkMode = false;
    }

    const sheetID = "19eSPpF1otsPfAmubvBNXKTLPzrjHeiKiNYnd8JN-GOM";
    const subjects = [
      { name: "Data Structure", sheet: "DS_T" },
      { name: "DS Practical", sheet: "DS_P" },
      { name: "Maths", sheet: "SF" },
      { name: "SEC", sheet: "SEC" },
      { name: "VAC", sheet: "VAC" },
      { name: "OS", sheet: "OS" },
      { name: "Python", sheet: "Python_T" },
      { name: "Python Practical", sheet: "Python_P" }
    ];

    function loadData() {
      const regNo = document.getElementById("regNoInput").value.trim();
      if (!regNo) return alert("Please enter your Register Number");

      const container = document.getElementById("container");
      const summary = document.getElementById("overall");
      const monthlyChart = document.getElementById("monthlyChart").getContext("2d");
      container.innerHTML = "";
      summary.innerText = "";

      const monthlyData = {};
      let totalHeld = 0, totalAttended = 0, completed = 0;

      subjects.forEach(subject => {
        const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:csv&sheet=${subject.sheet}`;

        fetch(url)
          .then(res => res.text())
          .then(csv => {
            const rows = csv.trim().split("\n").map(r => r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/));
            const headers = rows[0];
            const myRow = rows.find(r => r[3]?.replace(/"/g, "").trim() === regNo);
            if (!myRow) return;

            const held = parseFloat(myRow[4]?.replace(/"/g, "")) || 0;
            const attended = parseFloat(myRow[5]?.replace(/"/g, "")) || 0;
            totalHeld += held;
            totalAttended += attended;
            const percent = held ? (attended / held * 100).toFixed(1) : "0.0";

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
              <h3>${subject.name}</h3>
              <div class="ring">
                <svg width="100" height="100">
                  <circle class="bg" cx="50" cy="50" r="45" />
                  <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="282.6" stroke-dashoffset="${282.6 - (282.6 * percent / 100)}" />
                </svg>
                <span>${percent}%</span>
              </div>
              <p>${attended} / ${held} Classes</p>
              ${percent < 75 ? '<p class="risk">‚ö†Ô∏è At Risk</p>' : ''}
            `;
            container.appendChild(card);

            headers.forEach((h, i) => {
              const monthMatch = h.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)/i);
              if (monthMatch && h.includes("Held")) {
                const month = monthMatch[0];
                const held = parseFloat(myRow[i]?.replace(/"/g, "")) || 0;
                const attended = parseFloat(myRow[i + 1]?.replace(/"/g, "")) || 0;
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += attended;
              }
            });
          })
          .finally(() => {
            completed++;
            if (completed === subjects.length) {
              renderMonthlyChart(monthlyChart, monthlyData);
              const percent = totalHeld ? (totalAttended / totalHeld * 100).toFixed(1) : "0.0";
              const remaining = Math.ceil(((0.75 * totalHeld) - totalAttended) / 0.25);
              summary.innerText = `üìä Overall Attendance: ${totalAttended} / ${totalHeld} (${percent}%)\nüéØ Need ${remaining} more classes at 100% to reach 75%`;
            }
          });
      });
    }

    function renderMonthlyChart(ctx, dataMap) {
      const labels = Object.keys(dataMap);
      const data = labels.map(m => dataMap[m]);

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Monthly Attendance',
            data,
            backgroundColor: '#03a9f4'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function exportPDF() {
      html2canvas(document.body).then(canvas => {
        const img = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = canvas.height * pdfWidth / canvas.width;
        pdf.addImage(img, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("attendance.pdf");
      });
    }
  </script>
</body>
</html>
